<ion-header>
  <ion-toolbar>
    <ion-title>{{ currentUser?.role === 'worker' ? 'æˆ‘çš„æ•ˆç‡' : 'æ•ˆç‡ç»Ÿè®¡' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button [routerLink]="['/home']">
        <ion-icon name="home-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- å¤‡æ³¨æç¤º -->
  <ion-card *ngIf="!isWorker()" color="warning" class="note-card">
    <ion-card-content style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
      <ion-icon name="information-circle-outline" style="font-size: 18px;"></ion-icon>
      <div>
        <div><strong>å¤‡æ³¨ï¼š</strong>å½“æ ‡å‡†å·¥æ—¶èŠ¯ç‰‡æ˜¾ç¤ºä¸ºé»„è‰²ï¼ˆè¡¨ç¤ºéæ ‡ä»»åŠ¡ï¼‰æ—¶ï¼Œå¯ç‚¹å‡»è¯¥èŠ¯ç‰‡ä¿®æ”¹å¯¹åº”é˜¶æ®µçš„æ ‡å‡†å·¥æ—¶ã€‚</div>
        <div style="font-size: 12px; color: rgba(0,0,0,0.6);">ä¿®æ”¹åä¼šç«‹å³åŒæ­¥åˆ°åå°æ•°æ®ï¼Œè¯·è°¨æ…æ“ä½œã€‚</div>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- å·²ç¡®è®¤ä»»åŠ¡æç¤º -->
  <ion-card *ngIf="confirmedTasksCount > 0" color="success" class="note-card">
    <ion-card-content style="display: flex; align-items: center; justify-content: space-between; font-size: 14px;">
      <div style="display: flex; align-items: center; gap: 8px;">
        <ion-icon name="checkmark-circle-outline" style="font-size: 18px;"></ion-icon>
        <div>
          <div><strong>å·²ç¡®è®¤ä»»åŠ¡ï¼š</strong>ç³»ç»Ÿå·²è‡ªåŠ¨ç¡®è®¤ <strong>{{ confirmedTasksCount }}</strong> ä¸ª7ä¸ªå·¥ä½œæ—¥å‰çš„ä»»åŠ¡é˜¶æ®µï¼Œè¿™äº›ä»»åŠ¡å°†ä¸å†é‡æ–°è®¡ç®—ã€‚</div>
        </div>
      </div>
      <ion-button size="small" fill="outline" (click)="viewConfirmedTasks()">
        <ion-icon name="eye-outline" slot="start"></ion-icon>
        æŸ¥çœ‹è¯¦æƒ…
      </ion-button>
    </ion-card-content>
  </ion-card>

  <!-- ç­›é€‰æ¡ä»¶ -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>ç­›é€‰æ¡ä»¶</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="filter-row">
        <div class="filter-item">
          <ion-label position="stacked">å¼€å§‹æ—¥æœŸï¼ˆæŒ‰ç»“æŸæ—¶é—´ï¼‰</ion-label>
          <ion-input 
            type="date"
            [(ngModel)]="monthlyStartDate"
            placeholder="é€‰æ‹©å¼€å§‹æ—¥æœŸ"
            min="1900-01-01"
            max="2099-12-31"
            (input)="validateDateInput($event, 'monthlyStartDate')">
          </ion-input>
        </div>

        <div class="filter-item">
          <ion-label position="stacked">ç»“æŸæ—¥æœŸï¼ˆæŒ‰ç»“æŸæ—¶é—´ï¼‰</ion-label>
          <ion-input 
            type="date"
            [(ngModel)]="monthlyEndDate"
            placeholder="é€‰æ‹©ç»“æŸæ—¥æœŸ"
            min="1900-01-01"
            max="2099-12-31"
            (input)="validateDateInput($event, 'monthlyEndDate')">
          </ion-input>
        </div>
        
        <div class="filter-item filter-button">
          <div class="button-stack">
            <ion-button fill="outline" (click)="clearFilters()">
              <ion-icon name="refresh-outline" slot="start"></ion-icon>
              æ¸…ç©ºç­›é€‰
            </ion-button>
            <ion-button color="primary" (click)="calculateMonthlyEfficiency()" title="è¯·é€‰æ‹©é˜¶æ®µå¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´">
              <ion-icon name="bar-chart-outline" slot="start"></ion-icon>
              é˜¶æ®µæ•ˆç‡
            </ion-button>
            <ion-button *ngIf="isAdmin()" color="danger" fill="outline" (click)="clearConfirmedTasks()">
              <ion-icon name="refresh-circle-outline" slot="start"></ion-icon>
              æ¸…é™¤å·²ç¡®è®¤ä»»åŠ¡
            </ion-button>
            <ion-button color="success" (click)="openExportModal()">
              <ion-icon name="download-outline" slot="start"></ion-icon>
              å¯¼å‡ºæ•ˆç‡æ•°æ®
            </ion-button>
          </div>
        </div>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- å¯¼å‡ºæ•ˆç‡æ•°æ®æ¨¡æ€æ¡† -->
  <ion-modal [isOpen]="isExportModalOpen" (didDismiss)="closeExportModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>å¯¼å‡ºæ•ˆç‡æ•°æ®</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeExportModal()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <ion-card>
          <ion-card-header>
            <ion-card-title>å¯¼å‡ºé€‰é¡¹</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-item>
              <ion-label>å¯¼å‡ºç±»å‹</ion-label>
              <ion-select [(ngModel)]="exportType" interface="popover">
                <ion-select-option value="detail">æ•ˆç‡æ˜ç»†æ•°æ®</ion-select-option>
                <ion-select-option value="monthly">æœˆåº¦æ±‡æ€»æ•°æ®</ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">å¼€å§‹æ—¥æœŸï¼ˆæŒ‰é˜¶æ®µç»“æŸæ—¶é—´ï¼‰</ion-label>
              <ion-input
                type="date"
                [(ngModel)]="exportStartDate"
                min="1900-01-01"
                max="2099-12-31"
                (input)="validateDateInput($event, 'exportStartDate')">
              </ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">ç»“æŸæ—¥æœŸï¼ˆæŒ‰é˜¶æ®µç»“æŸæ—¶é—´ï¼‰</ion-label>
              <ion-input
                type="date"
                [(ngModel)]="exportEndDate"
                min="1900-01-01"
                max="2099-12-31"
                (input)="validateDateInput($event, 'exportEndDate')">
              </ion-input>
            </ion-item>

            <div style="margin-top: 16px;">
              <ion-button expand="block" color="success" (click)="confirmExport()">
                <ion-icon name="download-outline" slot="start"></ion-icon>
                ç¡®è®¤å¯¼å‡º
              </ion-button>
              <ion-button expand="block" fill="outline" (click)="closeExportModal()" style="margin-top: 8px;">
                å–æ¶ˆ
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- æœˆåº¦æ•ˆç‡æ±‡æ€»ï¼ˆè¡¨æ ¼æ ·å¼ï¼‰ -->
  <ion-card *ngIf="monthlyEfficiencyResults.length > 0" class="efficiency-card">
    <ion-card-header>
      <ion-card-title>æœˆåº¦æ•ˆç‡æ±‡æ€»</ion-card-title>
      <ion-card-subtitle>ä»»åŠ¡æœ‰æ•ˆå·¥æ—¶ä¹‹å’Œ Ã· æ ‡å‡†å·¥æ—¶ä¹‹å’Œï¼ˆæŒ‰å‘˜å·¥ + æœˆä»½æ±‡æ€»ï¼Œåœ¨æ‰€é€‰æ—¥æœŸèŒƒå›´å†…ï¼‰</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <div class="excel-table-scroll">
        <table class="excel-table">
          <thead>
            <tr>
              <th>åºå·</th>
              <th>å‘˜å·¥</th>
              <th>æœˆä»½</th>
              <th>æ ‡å‡†å·¥æ—¶(h)</th>
              <th>æœ‰æ•ˆå·¥æ—¶(h)</th>
              <th>æ•ˆç‡</th>
            </tr>
            <tr class="filter-row">
              <th>
                <span style="font-size: 11px; color: #666;">
                  å·²æ‰£é™¤å¼‚å¸¸æ—¶é—´å’ŒååŠ©æ—¶é—´
                </span>
              </th>
              <!-- å‘˜å·¥ç­›é€‰ -->
              <th>
                <input
                  *ngIf="!isWorker()"
                  class="table-filter-input"
                  placeholder="ç­›é€‰å‘˜å·¥"
                  [(ngModel)]="monthlyTableEmployeeFilter"
                  (ngModelChange)="calculateMonthlyEfficiency()">
                <span *ngIf="isWorker()" style="font-weight: 600; color: #333;">{{ currentUser?.name }}</span>
              </th>
              <!-- æœˆä»½ç­›é€‰ -->
              <th>
                <input
                  class="table-filter-input"
                  placeholder="ç­›é€‰æœˆä»½ å¦‚ 2025-03 æˆ– 3æœˆ"
                  [(ngModel)]="monthlyTableMonthFilter"
                  (ngModelChange)="calculateMonthlyEfficiency()">
              </th>
              <th></th>
              <th></th>
              <!-- æ•ˆç‡æ’åº -->
              <th>
                <select
                  class="table-filter-select"
                  [(ngModel)]="monthlyTableEfficiencySort"
                  (ngModelChange)="calculateMonthlyEfficiency()">
                  <option value="">ä¸æ’åº</option>
                  <option value="asc">å‡åº</option>
                  <option value="desc">é™åº</option>
                </select>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of getFilteredMonthlyResults(); let i = index">
              <td>{{ i + 1 }}</td>
              <td>{{ item.employee }}</td>
              <td>{{ item.monthLabel }}</td>
              <td>{{ item.standardHours }}h</td>
              <td>{{ item.actualHours }}h</td>
              <td>
                <ion-chip [color]="item.efficiency >= 100 ? 'success' : item.efficiency >= 80 ? 'warning' : 'danger'">
                  <ion-icon name="speedometer-outline"></ion-icon>
                  <ion-label>{{ item.efficiency }}%</ion-label>
                </ion-chip>
              </td>
            </tr>
            <!-- åˆè®¡è¡Œï¼šå½“å‰ç­›é€‰æ¡ä»¶ä¸‹çš„æ€»æ ‡å‡†å·¥æ—¶ / æ€»æœ‰æ•ˆå·¥æ—¶ / æ€»æ•ˆç‡ -->
            <tr class="monthly-total-row">
              <td colspan="3">åˆè®¡</td>
              <td>{{ getMonthlyTotal().standardHours }}h</td>
              <td>{{ getMonthlyTotal().actualHours }}h</td>
              <td>
                <ion-chip [color]="getMonthlyTotal().efficiency >= 100 ? 'success' : getMonthlyTotal().efficiency >= 80 ? 'warning' : 'danger'">
                  <ion-icon name="speedometer-outline"></ion-icon>
                  <ion-label>{{ getMonthlyTotal().efficiency.toFixed(2) }}%</ion-label>
                </ion-chip>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- åŠ è½½çŠ¶æ€ -->
  <ion-card *ngIf="loading">
    <ion-card-content class="ion-text-center">
      <ion-spinner></ion-spinner>
      <p>æ­£åœ¨ç»Ÿè®¡æ•ˆç‡...</p>
    </ion-card-content>
  </ion-card>

  <!-- æ•ˆç‡è®¡ç®—ç»“æœï¼ˆExcel è¡¨æ ¼æ ·å¼ï¼‰ -->
  <ion-card class="efficiency-card">
    <ion-card-header>
      <ion-card-title>æ•ˆç‡æ˜ç»†åˆ—è¡¨</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="excel-table-scroll">
        <table class="excel-table">
          <colgroup>
            <col class="col-index">
            <col class="col-task-name">
            <col class="col-phase">
            <col class="col-assignee">
            <col class="col-standard-hours">
            <col class="col-actual-hours">
            <col class="col-effective-hours"><!-- æ–°å¢ï¼šæœ‰æ•ˆå·¥æ—¶åˆ— -->
            <col class="col-efficiency">
            <col class="col-exception">
            <col class="col-ops">
          </colgroup>
          <thead>
            <tr>
              <th>åºå·</th>
              <th>ä»»åŠ¡åç§°</th>
              <th>é˜¶æ®µ</th>
              <th>è´Ÿè´£äºº</th>
              <th>æ ‡å‡†å·¥æ—¶(h)</th>
              <th>å®é™…å·¥æ—¶(h)</th>
              <th>æœ‰æ•ˆå·¥æ—¶(h)</th>
              <th>å®Œå·¥æ—¥æœŸ</th>
              <th>æ•ˆç‡</th>
              <th>å¼‚å¸¸</th>
              <th>æ“ä½œ</th>
            </tr>
            <tr class="filter-row">
              <th></th>
              <th>
                <input 
                  class="table-filter-input" 
                  placeholder="ç­›é€‰å‹å·" 
                  [(ngModel)]="tableModelFilter" 
                  (ngModelChange)="applyTableFilters()">
              </th>
              <th>
                <select 
                  class="table-filter-select" 
                  [(ngModel)]="tablePhaseFilter" 
                  (ngModelChange)="applyTableFilters()">
                  <option value="">å…¨éƒ¨é˜¶æ®µ</option>
                  <option value="machining">æœºåŠ é˜¶æ®µ</option>
                  <option value="electrical">ç”µæ°”é˜¶æ®µ</option>
                  <option value="pre_assembly">ç»„è£…å‰æ®µé˜¶æ®µ</option>
                  <option value="post_assembly">ç»„è£…åæ®µé˜¶æ®µ</option>
                  <option value="debugging">è°ƒè¯•é˜¶æ®µ</option>
                </select>
              </th>
              <th>
                <input 
                  *ngIf="!isWorker()"
                  class="table-filter-input" 
                  placeholder="ç­›é€‰è´Ÿè´£äºº" 
                  [(ngModel)]="tableAssigneeFilter" 
                  (ngModelChange)="applyTableFilters()">
                <span *ngIf="isWorker()" style="font-weight: 600; color: #333;">{{ currentUser?.name }}</span>
              </th>
              <th></th>
              <th></th>
              <th>
                <span style="font-size: 11px; color: #666;">
                  å·²æ‰£é™¤å¼‚å¸¸æ—¶é—´å’ŒååŠ©æ—¶é—´
                </span>
              </th>
              <th>
                <input 
                  class="table-filter-input"
                  type="date"
                  placeholder="å¼€å§‹æ—¥æœŸ"
                  [(ngModel)]="startDate"
                  min="1900-01-01"
                  max="2099-12-31"
                  (input)="validateDateInput($event, 'startDate')"
                  (ngModelChange)="applyTableFilters()">
                <input 
                  class="table-filter-input"
                  type="date"
                  placeholder="ç»“æŸæ—¥æœŸ"
                  [(ngModel)]="endDate"
                  min="1900-01-01"
                  max="2099-12-31"
                  (input)="validateDateInput($event, 'endDate')"
                  (ngModelChange)="applyTableFilters()"
                  style="margin-top: 4px;">
              </th>
              <th>
                <select 
                  class="table-filter-select" 
                  [(ngModel)]="tableEfficiencySort" 
                  (ngModelChange)="applyTableFilters()">
                  <option value="">ä¸æ’åº</option>
                  <option value="asc">å‡åº</option>
                  <option value="desc">é™åº</option>
                </select>
              </th>
              <th>
                <select 
                  class="table-filter-select" 
                  [(ngModel)]="tableExceptionSort" 
                  (ngModelChange)="applyTableFilters()">
                  <option value="">ä¸æ’åº</option>
                  <option value="asc">å‡åº</option>
                  <option value="desc">é™åº</option>
                </select>
              </th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let data of filteredEfficiencyData; let i = index">
              <td>{{ i + 1 }}</td>
              <td>
                {{ data.task.name }}
                <ion-chip *ngIf="data.hasAssistTasks" color="warning" size="small" style="margin-left: 8px;">
                  <ion-icon name="people-outline"></ion-icon>
                  <ion-label>ååŠ©</ion-label>
                </ion-chip>
              </td>
              <td>{{ getPhaseDisplayName(data.phase) }}</td>
              <td>{{ getTaskAssigneeName(data.task, data.phase) || '-' }}</td>
              <td>
                <ion-chip 
                  [color]="data.task.is_non_standard === 1 ? 'warning' : 'primary'" 
                  class="metric-chip"
                  [class.clickable-chip]="data.task.is_non_standard === 1 && !isWorker() && !isTaskConfirmed(data.task.id, data.phase)"
                  (click)="data.task.is_non_standard === 1 && !isWorker() && !isTaskConfirmed(data.task.id, data.phase) && openEditStandardHoursModal(data.task, data.phase)">
                  <ion-icon name="time-outline"></ion-icon>
                  <ion-label>{{ data.standardHours }}h</ion-label>
                  <ion-icon *ngIf="data.task.is_non_standard === 1 && !isWorker() && !isTaskConfirmed(data.task.id, data.phase)" name="create-outline" style="margin-left: 4px;"></ion-icon>
                </ion-chip>
              </td>
              <td>
                <ion-chip color="tertiary" class="metric-chip">
                  <ion-icon name="calendar-outline"></ion-icon>
                  <ion-label>{{ (data.actualWorkHours || 0).toFixed(1) }}h</ion-label>
                </ion-chip>
              </td>
              <td>
                <ion-chip color="success" class="metric-chip">
                  <ion-icon name="checkmark-circle-outline"></ion-icon>
                  <ion-label>
                    {{
                      (
                        (data.actualWorkHours || 0)
                        - (data.exceptionHours || 0)
                        - (data.assistHours || 0)
                      ).toFixed(1)
                    }}h
                  </ion-label>
                </ion-chip>
              </td>
              <td>
                {{ data.phaseEndTime ? formatDate(data.phaseEndTime) : '-' }}
              </td>
              <td>
                <ion-chip [color]="getEfficiencyColor(data.efficiency)" class="efficiency-chip">
                  <ion-icon name="trending-up-outline"></ion-icon>
                  <ion-label>{{ formatEfficiency(data.efficiency) }}</ion-label>
                </ion-chip>
              </td>
              <td>
                <ion-chip *ngIf="data.exceptionReports.length > 0" 
                          color="danger" 
                          (click)="toggleExceptionDetails(data.task.id, data.phase)"
                          class="clickable-chip metric-chip"
                          [title]="formatExceptionTooltip(data.exceptionReports)">
                  <ion-icon name="alert-circle-outline"></ion-icon>
                  <ion-label>{{ data.exceptionReports.length }}æ¡</ion-label>
                </ion-chip>
                <span *ngIf="data.exceptionReports.length === 0">-</span>
              </td>
              <td>
                <ion-button 
                  fill="outline" 
                  size="small" 
                  (click)="toggleCalculationDetails(data.task.id, data.phase)"
                  class="calculation-details-btn">
                  <ion-icon name="calculator-outline" slot="start"></ion-icon>
                  {{ getCalculationDetailsVisible(data.task.id, data.phase) ? 'éšè—' : 'è¯¦æƒ…' }}
                </ion-button>
              </td>
            </tr>
            <tr *ngIf="filteredEfficiencyData.length === 0">
              <td class="table-empty-row" colspan="11">
                æš‚æ— ç¬¦åˆæ¡ä»¶çš„æ•ˆç‡æ˜ç»†
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- è®¡ç®—è¿‡ç¨‹è¯¦æƒ…ï¼ˆä¿æŒåŸæœ‰å¡ç‰‡å±•ç¤ºï¼Œä»…åœ¨ç‚¹å‡»è¯¦æƒ…æ—¶æ˜¾ç¤ºï¼‰ -->
  <ng-container *ngFor="let data of filteredEfficiencyData">
    <ion-card *ngIf="getCalculationDetailsVisible(data.task.id, data.phase)" class="efficiency-card efficiency-card-row">
      <ion-card-content class="efficiency-row-content">
        <!-- ä»»åŠ¡åŸºæœ¬ä¿¡æ¯ -->
        <div class="task-info">
          <div class="task-title">
            <span class="task-name">{{ data.task.name }}</span>
            <span class="separator">-</span>
            <span class="phase-name">{{ getPhaseDisplayName(data.phase) }}</span>
          </div>
        </div>
        
        <!-- æ•ˆç‡æŒ‡æ ‡ -->
        <div class="efficiency-metrics">
          <ion-chip [color]="getEfficiencyColor(data.efficiency)" class="efficiency-chip">
            <ion-icon name="trending-up-outline"></ion-icon>
            <ion-label>æ•ˆç‡ {{ formatEfficiency(data.efficiency) }}</ion-label>
          </ion-chip>
          
          <ion-chip 
            [color]="data.task.is_non_standard === 1 ? 'warning' : 'primary'" 
            class="metric-chip"
            [class.clickable-chip]="data.task.is_non_standard === 1 && !isWorker() && !isTaskConfirmed(data.task.id, data.phase)"
            (click)="data.task.is_non_standard === 1 && !isWorker() && !isTaskConfirmed(data.task.id, data.phase) && openEditStandardHoursModal(data.task, data.phase)">
            <ion-icon name="time-outline"></ion-icon>
            <ion-label>æ ‡å‡† {{ data.standardHours }}h</ion-label>
            <ion-icon *ngIf="data.task.is_non_standard === 1 && !isWorker() && !isTaskConfirmed(data.task.id, data.phase)" name="create-outline" style="margin-left: 4px;"></ion-icon>
          </ion-chip>
          
          <ion-chip color="tertiary" class="metric-chip">
            <ion-icon name="calendar-outline"></ion-icon>
            <ion-label>å®é™… {{ (data.actualWorkHours || 0).toFixed(1) }}h</ion-label>
          </ion-chip>
        </div>
        
        <!-- è®¡ç®—è¿‡ç¨‹è¯¦æƒ… -->
        <div class="calculation-details">
        <div class="calculation-details-header">
          <h4>ğŸ“Š æ•ˆç‡è®¡ç®—è¿‡ç¨‹</h4>
          <ion-button 
            fill="outline" 
            size="small" 
            (click)="toggleCalculationDetails(data.task.id, data.phase)"
            class="calculation-toggle-btn">
            <ion-icon name="chevron-up-outline" slot="start"></ion-icon>
            éšè—è¯¦æƒ…
          </ion-button>
        </div>
        
        <!-- è®¡ç®—æ­¥éª¤åˆ—è¡¨ -->
        <ion-list>
          <ion-item class="calculation-step-item">
            <ion-label>
              <h3>1ï¸âƒ£ åŸºç¡€æ•°æ®</h3>
              <p class="calculation-info">
                <ion-icon name="information-circle-outline"></ion-icon>
                ä»»åŠ¡ID: {{ data.task.id }} | é˜¶æ®µ: {{ getPhaseDisplayName(data.phase) }}
                <span *ngIf="getTaskAssigneeName(data.task, data.phase)">| è´Ÿè´£äºº: {{ getTaskAssigneeName(data.task, data.phase) }}</span>
              </p>
              <p class="calculation-time">
                <ion-icon name="time-outline"></ion-icon>
                {{ formatTime(data.phaseStartTime) }} â†’ {{ formatTime(data.phaseEndTime) }}
                <span class="duration">({{ (data.totalCalendarHours || 0).toFixed(2) }}h)</span>
              </p>
            </ion-label>
          </ion-item>
          
          <ion-item class="calculation-step-item">
            <ion-label>
              <h3>2ï¸âƒ£ æ ‡å‡†å·¥æ—¶</h3>
              <p class="calculation-info">
                <ion-icon name="hourglass-outline"></ion-icon>
                æ ‡å‡†å·¥æ—¶: <strong>{{ data.standardHours }}å°æ—¶</strong>
              </p>
              <p class="calculation-description">
                <ion-icon name="document-text-outline"></ion-icon>
                æ¥æº: ä»»åŠ¡é…ç½®ä¸­çš„é˜¶æ®µé¢„ä¼°å·¥æ—¶
              </p>
            </ion-label>
          </ion-item>
          
          <ion-item class="calculation-step-item">
            <ion-label>
              <h3>3ï¸âƒ£ å®é™…å·¥ä½œå°æ—¶è®¡ç®—</h3>
              <p class="calculation-info">
                <ion-icon name="calculator-outline"></ion-icon>
                è®¡ç®—å…¬å¼: ä½œæ¯âˆ©é˜¶æ®µ + åŠ ç­âˆ©é˜¶æ®µ - è¯·å‡âˆ©ä½œæ¯ - å¼‚å¸¸âˆ©(ä½œæ¯+åŠ ç­)
              </p>
              <p class="calculation-result">
                <ion-icon name="checkmark-circle-outline"></ion-icon>
                è®¡ç®—ç»“æœ: <strong>{{ (data.actualWorkHours || 0).toFixed(2) }}å°æ—¶</strong>
              </p>
              
              <!-- é€æ—¥è®¡ç®—è¯¦æƒ… -->
              <div class="day-calculation-details">
                <h6>ğŸ“… é€æ—¥è®¡ç®—è¯¦æƒ…:</h6>
                <div *ngFor="let dayDetail of getDayCalculationDetails(data.task.id, data.phase)" class="day-detail-item">
                  <div class="day-detail-header">
                    <strong>{{ dayDetail.date }}</strong>
                    <span class="day-total">æ€»æ—¶é•¿: {{ (dayDetail.totalHours || 0).toFixed(2) }}h | æœ‰æ•ˆ: {{ (dayDetail.finalHours || 0).toFixed(2) }}h</span>
                  </div>
                  <div class="day-detail-breakdown">
                    <ion-chip color="primary" size="small">ä½œæ¯: {{ (dayDetail.workWindowOverlap || 0).toFixed(2) }}h</ion-chip>
                    <ion-chip color="secondary" size="small">åŠ ç­: {{ (dayDetail.overtimeOverlap || 0).toFixed(2) }}h</ion-chip>
                    <ion-chip color="warning" size="small">è¯·å‡: -{{ (dayDetail.leaveDeduction || 0).toFixed(2) }}h</ion-chip>
                    <ion-chip color="danger" size="small">å¼‚å¸¸: -{{ (dayDetail.exceptionDeduction || 0).toFixed(2) }}h</ion-chip>
                  </div>
                </div>
              </div>
            </ion-label>
          </ion-item>
          
          <ion-item class="calculation-step-item">
            <ion-label>
              <h3>4ï¸âƒ£ å¼‚å¸¸æ—¶é—´ç»Ÿè®¡</h3>
              <p class="calculation-info">
                <ion-icon name="warning-outline"></ion-icon>
                å¼‚å¸¸æ€»æ—¶é•¿: <strong>{{ (data.exceptionHours || 0).toFixed(2) }}å°æ—¶</strong>
              </p>
              <p class="calculation-description">
                <ion-icon name="list-outline"></ion-icon>
                å¼‚å¸¸è®°å½•æ•°: {{ data.exceptionReports.length }}æ¡
              </p>
              <div *ngIf="data.exceptionReports.length > 0" class="exception-breakdown">
                <div class="exception-breakdown-item" *ngFor="let exception of data.exceptionReports">
                  <ion-chip color="danger" size="small">
                    {{ exception.user_name }}: {{ (exception.duration_hours || 0).toFixed(2) }}h ({{ exception.exception_type }})
                  </ion-chip>
                </div>
              </div>
            </ion-label>
          </ion-item>
          
          <ion-item class="calculation-step-item" *ngIf="data.assistHours > 0">
            <ion-label>
              <h3>5ï¸âƒ£ ååŠ©æ—¶é—´ç»Ÿè®¡</h3>
              <p class="calculation-info">
                <ion-icon name="people-outline"></ion-icon>
                ååŠ©æ€»æ—¶é•¿: <strong>{{ (data.assistHours || 0).toFixed(2) }}å°æ—¶</strong>
              </p>
              <p class="calculation-description">
                <ion-icon name="information-circle-outline"></ion-icon>
                ååŠ©æ—¶é—´ä¼šä»æœ‰æ•ˆå·¥æ—¶ä¸­æ‰£é™¤ï¼ˆååŠ©å…¶ä»–ä»»åŠ¡/é˜¶æ®µçš„æ—¶é—´ï¼‰
              </p>
            </ion-label>
          </ion-item>
          
          <ion-item class="calculation-step-item">
            <ion-label>
              <h3>{{ data.assistHours > 0 ? '6ï¸âƒ£' : '5ï¸âƒ£' }} æ•ˆç‡è®¡ç®—</h3>
              <p class="calculation-info">
                <ion-icon name="trending-up-outline"></ion-icon>
                æ•ˆç‡å…¬å¼: (æ ‡å‡†å·¥æ—¶ Ã· æœ‰æ•ˆå·¥æ—¶) Ã— 100%
              </p>
              <p class="calculation-result">
                <ion-icon name="analytics-outline"></ion-icon>
                æœ‰æ•ˆå·¥æ—¶ = å®é™…å·¥æ—¶ - å¼‚å¸¸æ—¶é—´{{ data.assistHours > 0 ? ' - ååŠ©æ—¶é—´' : '' }}
              </p>
              <p class="calculation-result">
                <ion-icon name="calculations-outline"></ion-icon>
                è®¡ç®—è¿‡ç¨‹: ({{ data.standardHours }} Ã· {{ ((data.actualWorkHours || 0) - (data.exceptionHours || 0) - (data.assistHours || 0)).toFixed(2) }}) Ã— 100% = 
                <strong>{{ (data.efficiency || 0).toFixed(2) }}%</strong>
              </p>
              <p class="calculation-breakdown" style="margin-top: 8px; font-size: 0.9em; color: #666;">
                <span>æ ‡å‡†å·¥æ—¶: {{ data.standardHours }}h</span> | 
                <span>å®é™…å·¥æ—¶: {{ (data.actualWorkHours || 0).toFixed(2) }}h</span> | 
                <span>å¼‚å¸¸æ—¶é—´: {{ (data.exceptionHours || 0).toFixed(2) }}h</span>
                <span *ngIf="data.assistHours > 0"> | ååŠ©æ—¶é—´: {{ (data.assistHours || 0).toFixed(2) }}h</span>
              </p>
            </ion-label>
          </ion-item>
        </ion-list>
        
        <!-- è®¡ç®—ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="calculation-stats">
          <p class="calculation-total">
            <ion-icon name="analytics-outline"></ion-icon>
            æœ€ç»ˆæ•ˆç‡: <strong>{{ (data.efficiency || 0).toFixed(2) }}%</strong>
          </p>
          <p class="calculation-summary">
            <ion-icon name="information-circle-outline"></ion-icon>
            æ ‡å‡†å·¥æ—¶: {{ data.standardHours }}h | å®é™…å·¥æ—¶: {{ (data.actualWorkHours || 0).toFixed(2) }}h | å¼‚å¸¸æ—¶é•¿: {{ (data.exceptionHours || 0).toFixed(2) }}h
          </p>
        </div>
      </div>
      
      
      <!-- å¼‚å¸¸æ—¶é—´æ®µæ‘˜è¦ -->
      <div class="exception-summary" *ngIf="data.exceptionReports.length > 0 && getExceptionDetailsVisible(data.task.id, data.phase)">
        <div class="exception-summary-header">
          <h4>âš ï¸ å¼‚å¸¸æ—¶é—´æ®µè¯¦æƒ… ({{ data.exceptionReports.length }}æ¡)</h4>
          <ion-button 
            fill="outline" 
            size="small" 
            (click)="toggleExceptionDetails(data.task.id, data.phase)"
            class="exception-toggle-btn">
            <ion-icon name="chevron-up-outline" slot="start"></ion-icon>
            éšè—è¯¦æƒ…
          </ion-button>
        </div>
        
        <!-- å¼‚å¸¸æ—¶é—´æ®µåˆ—è¡¨ -->
        <ion-list>
          <ion-item *ngFor="let exception of data.exceptionReports" class="exception-summary-item">
            <ion-label>
              <div class="exception-header">
                <h3>{{ exception.user_name }} - {{ exception.exception_type }}</h3>
                <p class="exception-time">
                  <ion-icon name="time-outline"></ion-icon>
                  {{ formatTime(exception.start_time || exception.exception_start_datetime || null) }} 
                  â†’ 
                  {{ formatTime(exception.end_time || exception.exception_end_datetime || null) }}
                </p>
                <p class="exception-total">
                  <ion-icon name="warning-outline"></ion-icon>
                  æ€»å¼‚å¸¸æ—¶é•¿: <strong>{{ (data.exceptionHours || 0).toFixed(2) }}å°æ—¶</strong>
                </p>
              </div>
              <p class="exception-description" *ngIf="exception.description">{{ exception.description }}</p>
              <div class="exception-status" *ngIf="exception.approval_note">
                <ion-badge color="light" size="small" class="approval-note">
                  å¤‡æ³¨: {{ exception.approval_note }}
                </ion-badge>
              </div>
            </ion-label>
          </ion-item>
        </ion-list>
      </div>
      
      <!-- æŠ¥å·¥è®°å½• -->
      <div class="work-reports" *ngIf="data.workReports.length > 0 && getWorkReportsDetailsVisible(data.task.id, data.phase)">
        <div class="work-reports-header">
          <h4>ğŸ“‹ æŠ¥å·¥è®°å½•è¯¦æƒ… ({{ data.workReports.length }}æ¡)</h4>
          <ion-button 
            fill="outline" 
            size="small" 
            (click)="toggleWorkReportsDetails(data.task.id, data.phase)"
            class="work-reports-toggle-btn">
            <ion-icon name="chevron-up-outline" slot="start"></ion-icon>
            éšè—è¯¦æƒ…
          </ion-button>
        </div>
        <ion-list>
          <ion-item *ngFor="let report of data.workReports" class="work-report-item">
            <ion-label>
              <h3>{{ report.user_name }}</h3>
              <p class="work-report-time">
                <ion-icon name="time-outline"></ion-icon>
                {{ report.start_time ? formatTime(report.start_time) : 'æœªè®¾ç½®' }} 
                â†’ 
                {{ report.end_time ? formatTime(report.end_time) : 'æœªè®¾ç½®' }}
                <span class="duration">({{ report.hours_worked }}h)</span>
              </p>
              <p class="work-report-notes" *ngIf="report.quality_notes">
                <ion-icon name="document-text-outline"></ion-icon>
                {{ report.quality_notes }}
              </p>
            </ion-label>
          </ion-item>
        </ion-list>
      </div>
    </ion-card-content>
  </ion-card>
  </ng-container>

  <!-- ç¼–è¾‘æ ‡å‡†å·¥æ—¶æ¨¡æ€æ¡† -->
  <ion-modal [isOpen]="isEditStandardHoursModalOpen" (didDismiss)="closeEditStandardHoursModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>ç¼–è¾‘æ ‡å‡†å·¥æ—¶</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeEditStandardHoursModal()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content class="ion-padding">
        <ion-card>
          <ion-card-header>
            <ion-card-title>{{ editingTask?.name }}</ion-card-title>
            <ion-card-subtitle>{{ getPhaseDisplayName(editingPhase || '') }}</ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <ion-item>
              <ion-label position="stacked">æ ‡å‡†å·¥æ—¶ï¼ˆå°æ—¶ï¼‰</ion-label>
              <ion-input 
                type="number" 
                [(ngModel)]="editingStandardHours" 
                placeholder="è¯·è¾“å…¥æ ‡å‡†å·¥æ—¶"
                step="0.01"
                min="0">
              </ion-input>
            </ion-item>
            
            <div style="margin-top: 16px;">
              <ion-button expand="block" (click)="saveStandardHours()" [disabled]="!editingStandardHours || editingStandardHours <= 0">
                ä¿å­˜
              </ion-button>
              <ion-button expand="block" fill="outline" (click)="closeEditStandardHoursModal()" style="margin-top: 8px;">
                å–æ¶ˆ
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
