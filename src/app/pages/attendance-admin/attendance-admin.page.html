<ion-header>
  <ion-toolbar>
    <ion-title>è€ƒå‹¤ç®¡ç†</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="toggleStats()">
        <ion-icon name="bar-chart-outline"></ion-icon>
        <ion-label class="ion-padding-start">{{ showStats ? 'éšè—ç»Ÿè®¡' : 'æŸ¥çœ‹ç»Ÿè®¡' }}</ion-label>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- ç­›é€‰æ¡ä»¶ -->
  <ion-card>
    <ion-card-content>
      <div class="filter-row">
        <div class="filter-item">
          <ion-label>å¼€å§‹æ—¥æœŸ</ion-label>
          <input type="date" [(ngModel)]="start" class="filter-input" />
        </div>
        <div class="filter-item">
          <ion-label>ç»“æŸæ—¥æœŸ</ion-label>
          <input type="date" [(ngModel)]="end" class="filter-input" />
        </div>
        <div class="filter-item">
          <ion-label>å‘˜å·¥å§“å</ion-label>
          <input type="text" [(ngModel)]="userNameFilter" placeholder="å¯é€‰" class="filter-input" />
        </div>
        <div class="filter-item">
          <ion-label>ç­›é€‰å·¥æ®µ</ion-label>
          <ion-select 
            [(ngModel)]="selectedDepartmentFilter" 
            placeholder="é€‰æ‹©è½¦é—´"
            (ionChange)="onDepartmentFilterChange()"
            class="filter-select">
            <ion-select-option value="">å…¨éƒ¨å·¥æ®µ</ion-select-option>
            <ion-select-option *ngFor="let dept of availableDepartmentsFilter" [value]="dept">
              {{ dept }}
            </ion-select-option>
          </ion-select>
        </div>
        <div class="filter-item">
          <ion-label>ç­›é€‰ç»„</ion-label>
          <ion-select 
            [(ngModel)]="selectedGroupFilter" 
            placeholder="é€‰æ‹©ç»„"
            (ionChange)="onGroupFilterChange()"
            class="filter-select">
            <ion-select-option value="">å…¨éƒ¨ç»„</ion-select-option>
            <ion-select-option *ngFor="let group of availableGroupsFilter" [value]="group">
              {{ group }}
            </ion-select-option>
          </ion-select>
        </div>
        <div class="filter-actions">
          <ion-button size="small" (click)="load(true)">æŸ¥è¯¢</ion-button>
          <ion-button size="small" fill="clear" (click)="loadStats()">åˆ·æ–°ç»Ÿè®¡</ion-button>
          <ion-button size="small" fill="outline" (click)="clearFilters()">æ¸…ç©ºç­›é€‰</ion-button>
        </div>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- è€ƒå‹¤è°ƒæ•´è¯´æ˜ -->
  <ion-card style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-left: 4px solid #2196f3; margin-bottom: 16px;">
    <ion-card-content style="padding: 16px;">
      <div style="display: flex; align-items: start; gap: 12px;">
        <ion-icon name="information-circle-outline" style="font-size: 24px; color: #2196f3; flex-shrink: 0; margin-top: 2px;"></ion-icon>
        <div style="flex: 1;">
          <h3 style="margin: 0 0 8px 0; font-size: 15px; font-weight: 600; color: #1565c0;">è€ƒå‹¤è°ƒæ•´è¯´æ˜</h3>
          <div style="font-size: 13px; color: #424242; line-height: 1.6;">
            <p style="margin: 4px 0;">
              <strong>â€¢ èŠ‚å‡æ—¥ä¸Šç­ï¼š</strong>é»˜è®¤è€ƒå‹¤ä¸º0ï¼Œç‚¹å‡»"æ‰¹é‡è€ƒå‹¤ç®¡ç†"æŒ‰é’®ï¼Œå°†è€ƒå‹¤æ—¶é•¿è°ƒæ•´è‡³æ­£å¸¸å·¥ä½œæ—¶é•¿ï¼ˆä¾‹å¦‚7.58å°æ—¶ï¼‰
            </p>
            <p style="margin: 4px 0;">
              <strong>â€¢ æ™šä¸ŠåŠ ç­ï¼š</strong>ç‚¹å‡»å‘˜å·¥æ—è¾¹çš„"è°ƒæ•´"æŒ‰é’®ï¼Œè¾“å…¥å…·ä½“çš„æ—¶é—´æ®µï¼ˆå¦‚ï¼š19:00-22:00ï¼‰
            </p>
            <p style="margin: 4px 0;">
              <strong>â€¢ ç™½å¤©è¯·å‡ï¼š</strong>ç‚¹å‡»å‘˜å·¥æ—è¾¹çš„"è°ƒæ•´"æŒ‰é’®ï¼Œè¾“å…¥å…·ä½“çš„è¯·å‡æ—¶é—´æ®µï¼ˆå¦‚ï¼š09:00-11:00ï¼‰
            </p>
          </div>
        </div>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <ion-card *ngIf="showStats">
    <ion-card-header>
      <ion-card-title>è€ƒå‹¤ç»Ÿè®¡</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-spinner *ngIf="statsLoading" name="crescent"></ion-spinner>
      
      <div *ngIf="statsData && !statsLoading">
        <!-- æ€»ä½“ç»Ÿè®¡ -->
        <div class="stats-section">
          <h3>æ€»ä½“ç»Ÿè®¡</h3>
          <ion-item>
            <ion-label>æ€»è®°å½•æ•°</ion-label>
            <ion-badge color="primary">{{ statsData.overall.total_days || 0 }}</ion-badge>
          </ion-item>
          <ion-item>
            <ion-label>æ€»æ ‡å‡†è€ƒå‹¤æ—¶é•¿</ion-label>
            <ion-badge color="success">{{ formatHours(statsData.overall.total_standard_hours || 0) }}</ion-badge>
          </ion-item>
          <ion-item>
            <ion-label>æ€»åŠ ç­æ—¶é•¿</ion-label>
            <ion-badge color="warning">{{ formatHours(statsData.overall.total_overtime_hours || 0) }}</ion-badge>
          </ion-item>
          <ion-item>
            <ion-label>æ€»è¯·å‡æ—¶é•¿</ion-label>
            <ion-badge color="danger">{{ formatHours(statsData.overall.total_leave_hours || 0) }}</ion-badge>
          </ion-item>
          <ion-item>
            <ion-label>æ€»å®é™…æ—¶é•¿</ion-label>
            <ion-badge color="primary">{{ formatHours(statsData.overall.total_actual_hours || 0) }}</ion-badge>
          </ion-item>
        </div>
        
        <!-- æŒ‰ç”¨æˆ·ç»Ÿè®¡ -->
        <div class="stats-section" *ngIf="statsData.byUser && statsData.byUser.length > 0">
          <h3>æŒ‰ç”¨æˆ·ç»Ÿè®¡</h3>
          <ion-list>
            <ion-item *ngFor="let user of statsData.byUser">
              <ion-label>
                <h3>{{ user.user_name }}</h3>
                <p>è®°å½•æ•°: {{ user.record_count }}</p>
                <p>æ ‡å‡†è€ƒå‹¤æ—¶é•¿: {{ formatHours(user.total_standard_hours) }}</p>
                <p>åŠ ç­æ—¶é•¿: {{ formatHours(user.total_overtime_hours) }}</p>
                <p>è¯·å‡æ—¶é•¿: {{ formatHours(user.total_leave_hours) }}</p>
                <p>å®é™…æ—¶é•¿: {{ formatHours(user.total_actual_hours) }}</p>
              </ion-label>
            </ion-item>
          </ion-list>
        </div>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- åŠ è½½çŠ¶æ€ -->
  <ion-spinner *ngIf="isLoading" name="crescent"></ion-spinner>
  
  <!-- é”™è¯¯ä¿¡æ¯ -->
  <ion-card *ngIf="errorMsg">
    <ion-card-content style="color:#c0392b;">{{ errorMsg }}</ion-card-content>
  </ion-card>

  <!-- è€ƒå‹¤è®°å½•åˆ—è¡¨ï¼ˆæ—¥è€ƒå‹¤ï¼‰ -->
  <ion-list *ngIf="!isLoading && !errorMsg">
    <ion-item *ngFor="let r of list" class="compact-attendance-item">
      <ion-label>
        <!-- ç¬¬ä¸€è¡Œï¼šåŸºæœ¬ä¿¡æ¯ -->
        <div class="attendance-row-1">
          <div class="user-info">
            <strong>{{ r.user_name }}</strong>
            <span class="user-id">ï¼ˆID: {{ r.user_id }}ï¼‰</span>
            <span class="date-info">{{ r.date | date:'MM-dd' }}</span>
            <ion-badge *ngIf="isHoliday(r.date) || isWeekend(r.date)" color="warning" class="holiday-badge">
              {{ getHolidayName(r.date) || getWeekendName(r.date) }}
            </ion-badge>
          </div>
          <div class="time-info">
            <span class="time-label">æ ‡å‡†:</span>
            <span class="time-value">{{ formatHours(r.standard_attendance_hours) }}</span>
            <span *ngIf="r.overtime_hours > 0" class="time-label">åŠ ç­:</span>
            <span *ngIf="r.overtime_hours > 0" class="time-value overtime">{{ formatHours(r.overtime_hours) }}</span>
            <span *ngIf="calculateLeaveHours(r) > 0" class="time-label">è¯·å‡:</span>
            <span *ngIf="calculateLeaveHours(r) > 0" class="time-value leave">{{ formatHours(calculateLeaveHours(r)) }}</span>
            <span class="time-label">å®é™…:</span>
            <span class="time-value actual">{{ formatHours(calculateActualHours(r)) }}</span>
          </div>
        </div>
        
        <!-- ç¬¬äºŒè¡Œï¼šçŠ¶æ€å’Œæ“ä½œä¿¡æ¯ -->
        <div class="attendance-row-2">
          <div class="status-info">
            <!-- ç¡®è®¤çŠ¶æ€ -->
            <ion-badge *ngIf="r.is_confirmed" color="success" class="status-badge">
              <ion-icon name="checkmark-circle"></ion-icon>
              å·²ç¡®è®¤
            </ion-badge>
            <ion-badge *ngIf="!r.is_confirmed" color="warning" class="status-badge">
              <ion-icon name="time"></ion-icon>
              å¾…ç¡®è®¤
            </ion-badge>
            
            <!-- è°ƒæ•´ä¿¡æ¯ -->
            <span *ngIf="r.adjustment_note" class="adjustment-indicator">
              <ion-icon name="create-outline"></ion-icon>
              å·²è°ƒæ•´
            </span>
          </div>
          
          <div class="additional-info">
            <span *ngIf="r.confirmer_name" class="confirmer-info">ç¡®è®¤äºº: {{ r.confirmer_name }}</span>
            <span *ngIf="r.adjuster_name" class="adjuster-info">è°ƒæ•´äºº: {{ r.adjuster_name }}</span>
          </div>
        </div>
      </ion-label>
      
      <!-- æ“ä½œæŒ‰é’® -->
      <div slot="end">
        <ion-button size="small" fill="outline" color="primary" (click)="openAdjustModal(r)">
          <ion-icon name="create-outline"></ion-icon>
          è°ƒæ•´
        </ion-button>
        
        <!-- ç¡®è®¤/å–æ¶ˆç¡®è®¤æŒ‰é’® -->
        <ion-button 
          *ngIf="!r.is_confirmed" 
          size="small" 
          fill="outline" 
          color="success" 
          (click)="confirmAttendance(r)"
          class="ion-margin-start">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
          ç¡®è®¤
        </ion-button>
        
        <ion-button 
          *ngIf="r.is_confirmed" 
          size="small" 
          fill="outline" 
          color="warning" 
          (click)="unconfirmAttendance(r)"
          class="ion-margin-start">
          <ion-icon name="close-circle-outline"></ion-icon>
          å–æ¶ˆç¡®è®¤
        </ion-button>
      </div>
    </ion-item>
  </ion-list>

  <!-- åˆ†é¡µ -->
  <div class="ion-margin-top" *ngIf="total > pageSize">
    <ion-button size="small" (click)="prevPage()" [disabled]="page<=1">ä¸Šä¸€é¡µ</ion-button>
    <ion-button size="small" (click)="nextPage()" [disabled]="page*pageSize>=total" class="ion-margin-start">ä¸‹ä¸€é¡µ</ion-button>
    <span class="ion-padding-start">ç¬¬ {{ page }} é¡µ / å…± {{ totalPages }} é¡µ</span>
  </div>
</ion-content>

<!-- æ‰¹é‡æ“ä½œæŒ‰é’®ç»„ -->
<div class="batch-actions-row">
  <ion-button 
    expand="block" 
    fill="outline" 
    color="primary"
    (click)="openBatchAdjustModal()"
    class="batch-action-button">
    <ion-icon name="people" slot="start"></ion-icon>
    æ‰¹é‡è°ƒæ•´åŠ ç­æ—¶é—´
  </ion-button>
  
  <ion-button 
    expand="block" 
    fill="outline" 
    color="secondary"
    (click)="openBatchAttendanceModal()"
    class="batch-action-button">
    <ion-icon name="settings" slot="start"></ion-icon>
    æ‰¹é‡è€ƒå‹¤ç®¡ç†
  </ion-button>
  
  <ion-button 
    expand="block" 
    fill="outline" 
    color="tertiary"
    (click)="openWorkTimeModal()"
    class="batch-action-button"
    *ngIf="currentUser?.role === 'admin'">
    <ion-icon name="time" slot="start"></ion-icon>
    è°ƒæ•´å·¥ä½œæ—¶é—´
  </ion-button>
</div>

<!-- è€ƒå‹¤è°ƒæ•´æ¨¡æ€æ¡† -->
<ion-modal [isOpen]="isAdjustModalOpen" (didDismiss)="closeAdjustModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>è°ƒæ•´è€ƒå‹¤æ—¶é•¿</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeAdjustModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content class="ion-padding">
      <ion-card>
        <ion-card-header>
          <ion-card-title>{{ selectedRecord?.user_name }}</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p><strong>æ—¥æœŸï¼š</strong>{{ selectedRecord?.date | date:'yyyy-MM-dd' }} 
            <span *ngIf="workTimeSettings">{{ workTimeSettings.startTime }}-{{ workTimeSettings.endTime }}</span>
            <span *ngIf="!workTimeSettings" class="text-danger">å·¥ä½œæ—¶é—´æœªé…ç½®</span>
          </p>
          <p *ngIf="isHoliday(selectedRecord?.date) || isWeekend(selectedRecord?.date)" class="holiday-info">
            <ion-badge color="warning">{{ getHolidayName(selectedRecord?.date) || getWeekendName(selectedRecord?.date) }}</ion-badge>
          </p>
          <p><strong>æ ‡å‡†è€ƒå‹¤æ—¶é•¿ï¼š</strong>{{ formatHours(selectedRecord?.standard_attendance_hours || 0) }}</p>
          
          <ion-item>
            <ion-label position="stacked">åŠ ç­å¼€å§‹æ—¶é—´</ion-label>
            <ion-input 
              type="time" 
              [(ngModel)]="overtimeStartTime"
              placeholder="18:00"
              (ionInput)="onOvertimeStartTimeChange()">
            </ion-input>
          </ion-item>
          
          <ion-item>
            <ion-label position="stacked">åŠ ç­ç»“æŸæ—¶é—´</ion-label>
            <ion-input 
              type="time" 
              [(ngModel)]="overtimeEndTime"
              placeholder="20:00"
              (ionInput)="onOvertimeEndTimeChange()">
            </ion-input>
          </ion-item>
          
          <ion-item>
            <ion-label position="stacked">è¯·å‡å¼€å§‹æ—¶é—´</ion-label>
            <ion-input 
              type="time" 
              [(ngModel)]="leaveStartTime"
              placeholder="09:00"
              (ionInput)="onLeaveStartTimeChange()">
            </ion-input>
          </ion-item>
          
          <ion-item>
            <ion-label position="stacked">è¯·å‡ç»“æŸæ—¶é—´</ion-label>
            <ion-input 
              type="time" 
              [(ngModel)]="leaveEndTime"
              placeholder="11:00"
              (ionInput)="onLeaveEndTimeChange()">
            </ion-input>
          </ion-item>
          
          <ion-item>
            <ion-label position="stacked">è°ƒæ•´å¤‡æ³¨</ion-label>
            <ion-textarea 
              [(ngModel)]="adjustmentNote" 
              placeholder="è¯·è¾“å…¥è°ƒæ•´åŸå› "
              rows="3">
            </ion-textarea>
          </ion-item>
          
          <!-- é¢„è§ˆå®é™…æ—¶é•¿ -->
          <ion-item>
            <ion-label>
              <strong>å®é™…æ—¶é•¿ï¼š</strong>
              {{ formatHours(calculateCurrentActualHours()) }}
            </ion-label>
          </ion-item>
          
          <!-- æµ‹è¯•æŒ‰é’® -->
          <ion-button 
            expand="block" 
            fill="outline"
            color="secondary"
            (click)="testCalculation()"
            class="ion-margin-top">
            æµ‹è¯•è®¡ç®—é€»è¾‘
          </ion-button>
          
          <ion-button 
            expand="block" 
            color="primary"
            (click)="confirmAdjust()"
            class="ion-margin-top">
            ç¡®è®¤è°ƒæ•´
          </ion-button>
        </ion-card-content>
      </ion-card>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- æ‰¹é‡è°ƒæ•´æ¨¡æ€æ¡† -->
<ion-modal [isOpen]="isBatchAdjustModalOpen" (didDismiss)="closeBatchAdjustModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>æ‰¹é‡è°ƒæ•´åŠ ç­æ—¶é—´</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeBatchAdjustModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content class="ion-padding">
      <ion-card>
        <ion-card-header>
          <ion-card-title>é€‰æ‹©å‘˜å·¥</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <!-- æœç´¢å’Œç­›é€‰åŒºåŸŸ -->
          <ion-item>
            <ion-input 
              [(ngModel)]="searchKeyword" 
              placeholder="æœç´¢å‘˜å·¥å§“å"
              (ionInput)="filterUsers()"
              clearInput="true">
              <ion-icon name="search" slot="start"></ion-icon>
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label>ç­›é€‰ç»„</ion-label>
            <ion-select 
              [(ngModel)]="selectedGroup" 
              placeholder="é€‰æ‹©ç»„"
              (ionChange)="filterUsers()">
              <ion-select-option value="">å…¨éƒ¨ç»„</ion-select-option>
              <ion-select-option *ngFor="let group of availableGroups" [value]="group">
                {{ group }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <!-- å…¨é€‰/å–æ¶ˆå…¨é€‰æŒ‰é’® -->
          <div class="ion-margin-top">
            <ion-button 
              size="small" 
              fill="outline" 
              (click)="selectAllUsers()"
              [disabled]="filteredUsers.length === 0">
              å…¨é€‰
            </ion-button>
            <ion-button 
              size="small" 
              fill="outline" 
              (click)="clearAllUsers()"
              [disabled]="selectedUsers.length === 0"
              class="ion-margin-start">
              å–æ¶ˆå…¨é€‰
            </ion-button>
          </div>

          <!-- å‘˜å·¥åˆ—è¡¨ -->
          <ion-list>
            <ion-item *ngFor="let user of filteredUsers" button (click)="toggleUserSelection(user)">
              <ion-checkbox 
                slot="start" 
                [checked]="isUserSelected(user.id)">
              </ion-checkbox>
              <ion-label>
                <h3>{{ user.name }}</h3>
                <p>{{ user.department }}</p>
              </ion-label>
            </ion-item>
          </ion-list>

          <!-- æ— ç»“æœæç¤º -->
          <div *ngIf="filteredUsers.length === 0" class="ion-text-center ion-margin-top">
            <ion-text color="medium">
              <p>æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å‘˜å·¥</p>
            </ion-text>
          </div>
          
          <div class="ion-margin-top" *ngIf="selectedUsers.length > 0">
            <ion-text color="primary">
              <p>å·²é€‰æ‹© {{ selectedUsers.length }} åå‘˜å·¥</p>
            </ion-text>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-card *ngIf="selectedUsers.length > 0">
        <ion-card-header>
          <ion-card-title>è®¾ç½®åŠ ç­æ—¶é—´</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-item>
            <ion-label position="stacked">åŠ ç­å¼€å§‹æ—¶é—´</ion-label>
            <ion-input 
              type="time" 
              [(ngModel)]="batchOvertimeStartTime"
              placeholder="18:00"
              (ionInput)="onBatchOvertimeStartTimeChange()">
            </ion-input>
          </ion-item>
          
          <ion-item>
            <ion-label position="stacked">åŠ ç­ç»“æŸæ—¶é—´</ion-label>
            <ion-input 
              type="time" 
              [(ngModel)]="batchOvertimeEndTime"
              placeholder="20:00"
              (ionInput)="onBatchOvertimeEndTimeChange()">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">è°ƒæ•´æ—¥æœŸ</ion-label>
            <ion-datetime 
              [(ngModel)]="batchAdjustDate" 
              presentation="date"
              [max]="today">
            </ion-datetime>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">è°ƒæ•´å¤‡æ³¨</ion-label>
            <ion-textarea 
              [(ngModel)]="batchAdjustmentNote" 
              placeholder="è¯·è¾“å…¥è°ƒæ•´å¤‡æ³¨"
              rows="3">
            </ion-textarea>
          </ion-item>

          <!-- é¢„è§ˆåŠ ç­æ—¶é•¿ -->
          <ion-item>
            <ion-label>
              <strong>åŠ ç­æ—¶é•¿ï¼š</strong>
              {{ formatHours(calculateBatchOvertimeHours()) }}
            </ion-label>
          </ion-item>

          <ion-button 
            expand="block" 
            color="primary"
            (click)="confirmBatchAdjust()"
            class="ion-margin-top">
            ç¡®è®¤æ‰¹é‡è°ƒæ•´
          </ion-button>
        </ion-card-content>
      </ion-card>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- æ‰¹é‡è€ƒå‹¤ç®¡ç†æ¨¡æ€æ¡† -->
<ion-modal [isOpen]="isBatchAttendanceModalOpen" (didDismiss)="closeBatchAttendanceModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>æ‰¹é‡è€ƒå‹¤ç®¡ç†</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeBatchAttendanceModal()">
            âœ•
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <ion-card>
        <ion-card-header>
          <ion-card-title>æ‰¹é‡è®¾ç½®è€ƒå‹¤</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <!-- æ—¥æœŸé€‰æ‹© -->
          <ion-item>
            <ion-label position="stacked">é€‰æ‹©æ—¥æœŸ</ion-label>
            <ion-input 
              type="date" 
              [value]="getDateForHTML5Input()"
              [max]="today"
              (ionInput)="onDateInputChange($event)"
              placeholder="é€‰æ‹©æ—¥æœŸ">
            </ion-input>
          </ion-item>
          
          <!-- å¿«é€Ÿæ—¥æœŸé€‰æ‹©æŒ‰é’® -->
          <ion-item>
            <ion-label>å¿«é€Ÿé€‰æ‹©ï¼š</ion-label>
            <ion-button 
              fill="outline" 
              size="small"
              (click)="setToday()">
              ä»Šå¤©
            </ion-button>
            <ion-button 
              fill="outline" 
              size="small"
              (click)="setYesterday()">
              æ˜¨å¤©
            </ion-button>
            <ion-button 
              fill="outline" 
              size="small"
              (click)="setTomorrow()">
              æ˜å¤©
            </ion-button>
          </ion-item>
          
          <!-- æ˜¾ç¤ºå½“å‰é€‰æ‹©çš„æ—¥æœŸ -->
          <ion-item *ngIf="batchAttendanceDate">
            <ion-label>
              <strong>å½“å‰é€‰æ‹©æ—¥æœŸï¼š</strong>{{ batchAttendanceDate }}
            </ion-label>
          </ion-item>
          

          <!-- è€ƒå‹¤æ—¶é•¿è®¾ç½® -->
          <ion-item>
            <ion-label position="stacked">è€ƒå‹¤æ—¶é•¿ï¼ˆå°æ—¶ï¼‰</ion-label>
            <ion-input 
              type="number" 
              [(ngModel)]="batchAttendanceHours" 
              placeholder="è¯·è¾“å…¥è€ƒå‹¤æ—¶é•¿"
              step="0.01"
              min="0"
              max="24">
            </ion-input>
          </ion-item>
          
          <!-- è€ƒå‹¤æ—¶é•¿è¯´æ˜ -->
          <ion-item>
            <ion-label>
              <ion-text color="medium">
                <small *ngIf="workTimeSettings?.standardHours">
                  ğŸ’¡ å¤‡æ³¨ï¼šæ”¾å‡è€ƒå‹¤ä¸º0ï¼Œä¸Šç­è€ƒå‹¤ä¸º <strong>{{ workTimeSettings.standardHours }}å°æ—¶</strong>ï¼ˆæ ¹æ®å·¥ä½œæ—¶é—´è®¾ç½®è‡ªåŠ¨è®¡ç®—ï¼‰
                </small>
                <small *ngIf="!workTimeSettings?.standardHours">
                  ğŸ’¡ å¤‡æ³¨ï¼šæ”¾å‡è€ƒå‹¤ä¸º0ï¼Œä¸Šç­è€ƒå‹¤æ ¹æ®å·¥ä½œæ—¶é—´è®¾ç½®è‡ªåŠ¨è®¡ç®—ï¼ˆè¯·å…ˆé…ç½®å·¥ä½œæ—¶é—´ï¼‰
                </small>
              </ion-text>
            </ion-label>
          </ion-item>

          <!-- å¤‡æ³¨ -->
          <ion-item>
            <ion-label position="stacked">å¤‡æ³¨</ion-label>
            <ion-textarea 
              [(ngModel)]="batchAttendanceNote" 
              placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯">
            </ion-textarea>
          </ion-item>

          <!-- å·¥äººé€‰æ‹© -->
          <ion-item>
            <ion-label>é€‰æ‹©å·¥äºº</ion-label>
            <ion-button fill="outline" (click)="selectAllWorkers()">å…¨é€‰</ion-button>
            <ion-button fill="outline" (click)="clearAllWorkers()" class="ion-margin-start">æ¸…ç©º</ion-button>
          </ion-item>

          <!-- æœç´¢å’Œç­›é€‰ -->
          <ion-item>
            <ion-input 
              [(ngModel)]="searchKeyword" 
              placeholder="æœç´¢å·¥äººå§“å"
              (ionInput)="filterWorkers()">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label>ç­›é€‰ç»„</ion-label>
            <ion-select [(ngModel)]="selectedGroup" (ionChange)="filterWorkers()">
              <ion-select-option value="">å…¨éƒ¨ç»„</ion-select-option>
              <ion-select-option *ngFor="let group of availableGroups" [value]="group">
                {{ group }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <!-- å·¥äººåˆ—è¡¨ -->
          <ion-list>
            <ion-item *ngFor="let user of filteredWorkers">
              <ion-checkbox 
                [(ngModel)]="user.selected" 
                (ionChange)="onWorkerSelectionChange()">
              </ion-checkbox>
              <ion-label class="ion-margin-start">
                <h3>{{ user.name }}</h3>
                <p>{{ user.department }}</p>
              </ion-label>
            </ion-item>
          </ion-list>

          <!-- ç»Ÿè®¡ä¿¡æ¯ -->
          <ion-item>
            <ion-label>
              <strong>å·²é€‰æ‹©ï¼š</strong>{{ selectedWorkersCount }} åå·¥äºº
            </ion-label>
          </ion-item>

          <ion-item>
            <ion-label>
              <strong>è€ƒå‹¤æ—¶é•¿ï¼š</strong>{{ batchAttendanceHours || 0 }} å°æ—¶
            </ion-label>
          </ion-item>

          <ion-button 
            expand="block" 
            color="primary"
            (click)="confirmBatchAttendance()"
            [disabled]="selectedWorkersCount === 0 || batchAttendanceHours === null || batchAttendanceHours === undefined"
            class="ion-margin-top">
            ç¡®è®¤æ‰¹é‡è®¾ç½®
          </ion-button>
        </ion-card-content>
      </ion-card>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- å·¥ä½œæ—¶é—´è®¾ç½®æ¨¡æ€æ¡† -->
<ion-modal [isOpen]="isWorkTimeModalOpen" (didDismiss)="closeWorkTimeModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>è°ƒæ•´å·¥ä½œæ—¶é—´</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeWorkTimeModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content class="ion-padding">
      <ion-card>
        <ion-card-header>
          <ion-card-title>é»˜è®¤å·¥ä½œæ—¶é—´è®¾ç½®</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-item>
            <ion-label position="stacked">ä¸Šç­æ—¶é—´</ion-label>
            <ion-input 
              type="time" 
              [(ngModel)]="workTimeSettings.startTime"
              (ionInput)="calculateStandardHours()">
            </ion-input>
          </ion-item>
          
          <ion-item>
            <ion-label position="stacked">ä¸‹ç­æ—¶é—´</ion-label>
            <ion-input 
              type="time" 
              [(ngModel)]="workTimeSettings.endTime"
              (ionInput)="calculateStandardHours()">
            </ion-input>
          </ion-item>
          
          <ion-item>
            <ion-label position="stacked">åˆä¼‘å¼€å§‹æ—¶é—´</ion-label>
            <ion-input 
              type="time" 
              [(ngModel)]="workTimeSettings.lunchStartTime"
              (ionInput)="calculateStandardHours()">
            </ion-input>
          </ion-item>
          
          <ion-item>
            <ion-label position="stacked">åˆä¼‘ç»“æŸæ—¶é—´</ion-label>
            <ion-input 
              type="time" 
              [(ngModel)]="workTimeSettings.lunchEndTime"
              (ionInput)="calculateStandardHours()">
            </ion-input>
          </ion-item>
          
          <ion-item>
            <ion-label position="stacked">å…¶ä½™ä¼‘æ¯æ—¶é—´</ion-label>
            <div style="display: flex; gap: 10px; width: 100%;">
              <ion-input 
                type="time" 
                [(ngModel)]="workTimeSettings.otherBreakStartTime"
                (ionInput)="calculateStandardHours()"
                style="flex: 1;">
              </ion-input>
              <span style="align-self: center; color: #666;">è‡³</span>
              <ion-input 
                type="time" 
                [(ngModel)]="workTimeSettings.otherBreakEndTime"
                (ionInput)="calculateStandardHours()"
                style="flex: 1;">
              </ion-input>
            </div>
            <ion-note slot="helper">å¦‚ï¼šä¸ŠåˆèŒ¶æ­‡ã€ä¸‹åˆèŒ¶æ­‡ç­‰æ—¶é—´æ®µ</ion-note>
          </ion-item>
          
          <ion-item>
            <ion-label position="stacked">æ ‡å‡†å·¥ä½œæ—¶é•¿ï¼ˆå°æ—¶ï¼‰</ion-label>
            <ion-input 
              type="number" 
              [(ngModel)]="workTimeSettings.standardHours"
              placeholder="0.00"
              step="0.01"
              readonly>
            </ion-input>
            <ion-note slot="helper">è‡ªåŠ¨è®¡ç®—ï¼šæ€»æ—¶é—´ - åˆä¼‘æ—¶é—´ - å…¶ä½™ä¼‘æ¯æ—¶é—´</ion-note>
          </ion-item>
          
          <ion-item>
            <ion-label position="stacked">åˆå§‹åŠ ç­æ—¶é—´</ion-label>
            <ion-input 
              type="time" 
              [(ngModel)]="workTimeSettings.defaultOvertimeStartTime"
              placeholder="18:00">
            </ion-input>
            <ion-note slot="helper">è®¾ç½®åï¼Œè°ƒæ•´è€ƒå‹¤æ—¶åŠ ç­å¼€å§‹æ—¶é—´å°†é»˜è®¤ä½¿ç”¨æ­¤æ—¶é—´</ion-note>
          </ion-item>
          
          <ion-item>
            <ion-label position="stacked">ç»“æŸåŠ ç­æ—¶é—´</ion-label>
            <ion-input 
              type="time" 
              [(ngModel)]="workTimeSettings.defaultOvertimeEndTime"
              placeholder="20:00">
            </ion-input>
            <ion-note slot="helper">è®¾ç½®åï¼Œè°ƒæ•´è€ƒå‹¤æ—¶åŠ ç­ç»“æŸæ—¶é—´å°†é»˜è®¤ä½¿ç”¨æ­¤æ—¶é—´</ion-note>
          </ion-item>
          
          <ion-item>
            <ion-label position="stacked">å¤‡æ³¨</ion-label>
            <ion-textarea 
              [(ngModel)]="workTimeSettings.note" 
              placeholder="å·¥ä½œæ—¶é—´è®¾ç½®è¯´æ˜"
              rows="3">
            </ion-textarea>
          </ion-item>
          
          <div class="ion-margin-top">
            <ion-button 
              expand="block" 
              color="primary"
              (click)="saveWorkTimeSettings()"
              [disabled]="isSubmitting"
              class="ion-margin-bottom">
              <ion-spinner *ngIf="isSubmitting" name="crescent"></ion-spinner>
              <span *ngIf="!isSubmitting">ä¿å­˜è®¾ç½®</span>
            </ion-button>
            
            <ion-button 
              expand="block" 
              color="medium" 
              fill="outline"
              (click)="resetWorkTimeSettings()"
              [disabled]="isSubmitting">
              é‡ç½®ä¸ºé»˜è®¤
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
      
      <ion-card>
        <ion-card-header>
          <ion-card-title>å½“å‰è®¾ç½®é¢„è§ˆ</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p><strong>å·¥ä½œæ—¶é—´ï¼š</strong>{{ workTimeSettings?.startTime || 'æœªè®¾ç½®' }} - {{ workTimeSettings?.endTime || 'æœªè®¾ç½®' }}</p>
          <p><strong>åˆä¼‘æ—¶é—´ï¼š</strong>{{ workTimeSettings?.lunchStartTime || 'æœªè®¾ç½®' }} - {{ workTimeSettings?.lunchEndTime || 'æœªè®¾ç½®' }}</p>
          <p *ngIf="workTimeSettings.otherBreakStartTime && workTimeSettings.otherBreakEndTime">
            <strong>å…¶ä½™ä¼‘æ¯æ—¶é—´ï¼š</strong>{{ workTimeSettings.otherBreakStartTime }} - {{ workTimeSettings.otherBreakEndTime }}
          </p>
          <p><strong>æ ‡å‡†å·¥ä½œæ—¶é•¿ï¼š</strong>{{ workTimeSettings.standardHours || '0.00' }} å°æ—¶</p>
          <p *ngIf="workTimeSettings.defaultOvertimeStartTime">
            <strong>åˆå§‹åŠ ç­æ—¶é—´ï¼š</strong>{{ workTimeSettings.defaultOvertimeStartTime }}
          </p>
          <p *ngIf="workTimeSettings.defaultOvertimeEndTime">
            <strong>ç»“æŸåŠ ç­æ—¶é—´ï¼š</strong>{{ workTimeSettings.defaultOvertimeEndTime }}
          </p>
          <p *ngIf="workTimeSettings.note"><strong>å¤‡æ³¨ï¼š</strong>{{ workTimeSettings.note }}</p>
        </ion-card-content>
      </ion-card>
    </ion-content>
  </ng-template>
</ion-modal>