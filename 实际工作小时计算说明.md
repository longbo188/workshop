# å®é™…å·¥ä½œå°æ—¶è®¡ç®—è¯¦ç»†è¯´æ˜

## ğŸ“Š æ ¸å¿ƒè®¡ç®—å…¬å¼

```
å®é™…å·¥ä½œå°æ—¶ = ä½œæ¯âˆ©é˜¶æ®µ + åŠ ç­âˆ©é˜¶æ®µ - è¯·å‡âˆ©ä½œæ¯ - å¼‚å¸¸âˆ©(ä½œæ¯+åŠ ç­)
```

## ğŸ” è®¡ç®—æ­¥éª¤è¯¦è§£

### 1ï¸âƒ£ é€æ—¥è®¡ç®—
ç³»ç»Ÿä¼šéå†ä»»åŠ¡é˜¶æ®µçš„æ¯ä¸€å¤©ï¼Œåˆ†åˆ«è®¡ç®—æ¯å¤©çš„æœ‰æ•ˆå·¥ä½œå°æ—¶ï¼Œç„¶åç´¯åŠ å¾—åˆ°æ€»çš„å·¥ä½œå°æ—¶ã€‚

### 2ï¸âƒ£ æ¯æ—¥è®¡ç®—è¿‡ç¨‹

#### æ­¥éª¤1ï¼šè®¡ç®—ä½œæ¯æ—¶é—´ä¸é˜¶æ®µçš„é‡å 
- **ä½œæ¯æ—¶é—´çª—å£**ï¼šæ ¹æ®å…¬å¸å·¥ä½œæ—¶é—´è®¾ç½®
  - ä¸Šåˆå·¥ä½œçª—å£ï¼š08:30 - 11:50 (3.33å°æ—¶)
  - ä¸‹åˆå·¥ä½œçª—å£ï¼š13:20 - 17:50 (4.5å°æ—¶)
  - å…¶ä»–ä¼‘æ¯æ—¶é—´ï¼š16:00 - 16:15 (0.25å°æ—¶)
- **è®¡ç®—æ–¹å¼**ï¼šä½œæ¯æ—¶é—´çª—å£ âˆ© ä»»åŠ¡é˜¶æ®µæ—¶é—´
- **ç¤ºä¾‹**ï¼šå¦‚æœä»»åŠ¡é˜¶æ®µæ˜¯ 09:00-16:00ï¼Œåˆ™ï¼š
  - ä¸Šåˆé‡å ï¼š09:00-11:50 = 2.83å°æ—¶
  - ä¸‹åˆé‡å ï¼š13:20-16:00 = 2.67å°æ—¶
  - æ€»è®¡ï¼š5.5å°æ—¶

#### æ­¥éª¤2ï¼šè®¡ç®—åŠ ç­æ—¶é—´ä¸é˜¶æ®µçš„é‡å 
- **åŠ ç­æ—¶é—´**ï¼šä»è€ƒå‹¤è®°å½•ä¸­è·å–
  - å…·ä½“æ—¶é—´æ®µï¼šå¦‚ 18:00-20:00
  - æˆ–æ ¹æ®åŠ ç­å°æ—¶æ•°æ¨ç®—ï¼šé»˜è®¤ 18:00-20:00
- **è®¡ç®—æ–¹å¼**ï¼šåŠ ç­æ—¶é—´ âˆ© ä»»åŠ¡é˜¶æ®µæ—¶é—´
- **ç¤ºä¾‹**ï¼šå¦‚æœä»»åŠ¡é˜¶æ®µæ˜¯ 09:00-19:00ï¼ŒåŠ ç­æ˜¯ 18:00-20:00ï¼Œåˆ™ï¼š
  - é‡å ï¼š18:00-19:00 = 1å°æ—¶

#### æ­¥éª¤3ï¼šæ‰£é™¤è¯·å‡æ—¶é—´
- **è¯·å‡æ—¶é—´**ï¼šä»è€ƒå‹¤è®°å½•ä¸­è·å–
- **è®¡ç®—æ–¹å¼**ï¼šè¯·å‡æ—¶é—´ âˆ© ä½œæ¯æ—¶é—´çª—å£
- **ç¤ºä¾‹**ï¼šå¦‚æœè¯·å‡æ˜¯ 10:00-11:00ï¼Œä½œæ¯çª—å£æ˜¯ 08:30-12:00ï¼Œåˆ™ï¼š
  - é‡å ï¼š10:00-11:00 = 1å°æ—¶ï¼ˆéœ€è¦æ‰£é™¤ï¼‰

#### æ­¥éª¤4ï¼šæ‰£é™¤å¼‚å¸¸æ—¶é—´
- **å¼‚å¸¸æ—¶é—´**ï¼šä»å¼‚å¸¸æŠ¥å‘Šä¸­è·å–
- **è®¡ç®—æ–¹å¼**ï¼šå¼‚å¸¸æ—¶é—´ âˆ© (ä½œæ¯æ—¶é—´ + åŠ ç­æ—¶é—´)
- **ç¤ºä¾‹**ï¼šå¦‚æœå¼‚å¸¸æ˜¯ 14:00-15:00ï¼Œä½œæ¯çª—å£æ˜¯ 13:00-17:50ï¼Œåˆ™ï¼š
  - é‡å ï¼š14:00-15:00 = 1å°æ—¶ï¼ˆéœ€è¦æ‰£é™¤ï¼‰

#### æ­¥éª¤5ï¼šåº”ç”¨æ¯æ—¥é™åˆ¶
- **é™åˆ¶æ¡ä»¶**ï¼šmin(è®¡ç®—å‡ºçš„æœ‰æ•ˆå·¥æ—¶, å½“æ—¥å®é™…å‡ºå‹¤æ—¶é—´)
- **ç›®çš„**ï¼šç¡®ä¿ä¸ä¼šè¶…è¿‡å‘˜å·¥å½“å¤©çš„å®é™…å‡ºå‹¤æ—¶é—´

## ğŸ“… å…·ä½“è®¡ç®—ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šæ­£å¸¸å·¥ä½œæ—¥
**ä»»åŠ¡é˜¶æ®µ**ï¼š2025-10-22 08:36:42 - 15:00:42
**ä½œæ¯çª—å£**ï¼š08:30-11:50, 13:20-17:50
**å…¶ä»–ä¼‘æ¯**ï¼š16:00-16:15

**è®¡ç®—è¿‡ç¨‹**ï¼š
1. ä½œæ¯æ—¶é—´é‡å ï¼š
   - ä¸Šåˆï¼š08:36-11:50 = 3.23å°æ—¶
   - ä¸‹åˆï¼š13:20-15:00 = 1.67å°æ—¶
   - æ‰£é™¤å…¶ä»–ä¼‘æ¯ï¼š16:00-16:15 = 0.25å°æ—¶ï¼ˆä¸åœ¨æ­¤æ—¶é—´æ®µå†…ï¼‰
   - å°è®¡ï¼š4.9å°æ—¶

2. åŠ ç­æ—¶é—´é‡å ï¼šæ— 
3. è¯·å‡æ—¶é—´æ‰£é™¤ï¼šæ— 
4. å¼‚å¸¸æ—¶é—´æ‰£é™¤ï¼šæ— 
5. å½“æ—¥æœ‰æ•ˆå·¥æ—¶ï¼š4.9å°æ—¶
6. å®é™…å‡ºå‹¤é™åˆ¶ï¼š8å°æ—¶
7. æœ€ç»ˆè®¡å…¥å·¥æ—¶ï¼šmin(4.9, 8) = 4.9å°æ—¶

### ç¤ºä¾‹2ï¼šåŒ…å«åŠ ç­å’Œè¯·å‡
**ä»»åŠ¡é˜¶æ®µ**ï¼š2025-10-22 08:00:00 - 20:00:00
**ä½œæ¯çª—å£**ï¼š08:30-11:50, 13:20-17:50
**åŠ ç­æ—¶é—´**ï¼š18:00-20:00
**è¯·å‡æ—¶é—´**ï¼š10:00-11:00

**è®¡ç®—è¿‡ç¨‹**ï¼š
1. ä½œæ¯æ—¶é—´é‡å ï¼š
   - ä¸Šåˆï¼š08:30-11:50 = 3.33å°æ—¶
   - ä¸‹åˆï¼š13:20-17:50 = 4.5å°æ—¶
   - å°è®¡ï¼š7.83å°æ—¶

2. åŠ ç­æ—¶é—´é‡å ï¼š
   - 18:00-20:00 = 2å°æ—¶

3. è¯·å‡æ—¶é—´æ‰£é™¤ï¼š
   - 10:00-11:00 ä¸ 08:30-11:50 é‡å  = 1å°æ—¶

4. å¼‚å¸¸æ—¶é—´æ‰£é™¤ï¼šæ— 
5. å½“æ—¥æœ‰æ•ˆå·¥æ—¶ï¼š7.83 + 2 - 1 = 8.83å°æ—¶
6. å®é™…å‡ºå‹¤é™åˆ¶ï¼š8å°æ—¶
7. æœ€ç»ˆè®¡å…¥å·¥æ—¶ï¼šmin(8.83, 8) = 8å°æ—¶

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### æ—¶é—´é‡å è®¡ç®—å‡½æ•°
```typescript
private getOverlapHours(start1: Date, end1: Date, start2: Date, end2: Date): number {
  const overlapStart = new Date(Math.max(start1.getTime(), start2.getTime()));
  const overlapEnd = new Date(Math.min(end1.getTime(), end2.getTime()));
  
  if (overlapStart >= overlapEnd) return 0;
  
  return (overlapEnd.getTime() - overlapStart.getTime()) / (1000 * 60 * 60);
}
```

### å·¥ä½œæ—¶é—´çª—å£è®¡ç®—
```typescript
private getWorkWindowsForDay(workTimeSettings: any, dateStr: string): Array<{start: string, end: string}> {
  const startTime = workTimeSettings.start_time;        // 08:30
  const endTime = workTimeSettings.end_time;            // 17:50
  const lunchStart = workTimeSettings.lunch_start_time; // 12:00
  const lunchEnd = workTimeSettings.lunch_end_time;     // 13:00
  const otherStart = workTimeSettings.other_break_start_time; // 10:00
  const otherEnd = workTimeSettings.other_break_end_time;     // 10:15

  let windows = [
    { start: startTime, end: lunchStart },  // 08:30-12:00
    { start: lunchEnd, end: endTime }       // 13:00-17:50
  ];

  // æ‰£é™¤å…¶ä»–ä¼‘æ¯æ—¶é—´
  if (otherStart && otherEnd) {
    windows = this.splitWindowsByBreak(windows, otherStart, otherEnd);
  }

  return windows;
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ—¶é—´æ ¼å¼**ï¼šæ‰€æœ‰æ—¶é—´éƒ½ä½¿ç”¨æœ¬åœ°æ—¶é—´ï¼Œä¸è¿›è¡ŒUTCè½¬æ¢
2. **æ•°æ®æ¥æº**ï¼šå·¥ä½œæ—¶é—´è®¾ç½®ä»æ•°æ®åº“çš„ `work_time_settings` è¡¨è·å–
3. **è€ƒå‹¤è®°å½•**ï¼šåªä½¿ç”¨å·²ç¡®è®¤çš„è€ƒå‹¤è®°å½•ï¼ˆ`confirmed = 1`ï¼‰
4. **å¼‚å¸¸æŠ¥å‘Š**ï¼šåªä½¿ç”¨å·²æ‰¹å‡†çš„å¼‚å¸¸æŠ¥å‘Šï¼ˆ`status = 'approved'`ï¼‰
5. **æ¯æ—¥é™åˆ¶**ï¼šç¡®ä¿ä¸ä¼šè¶…è¿‡å‘˜å·¥å½“å¤©çš„å®é™…å‡ºå‹¤æ—¶é—´
6. **è´Ÿæ•°å¤„ç†**ï¼šè®¡ç®—ç»“æœç¡®ä¿ä¸ä¸ºè´Ÿæ•°

## ğŸ“ˆ æ•ˆç‡è®¡ç®—

æœ€ç»ˆæ•ˆç‡ = (æ ‡å‡†å·¥æ—¶ Ã· å®é™…å·¥ä½œå°æ—¶) Ã— 100%

å…¶ä¸­ï¼š
- **æ ‡å‡†å·¥æ—¶**ï¼šä»ä»»åŠ¡é…ç½®ä¸­è·å–çš„é˜¶æ®µé¢„ä¼°å·¥æ—¶
- **å®é™…å·¥ä½œå°æ—¶**ï¼šé€šè¿‡ä¸Šè¿°å¤æ‚è®¡ç®—å¾—å‡ºçš„æœ‰æ•ˆå·¥ä½œå°æ—¶æ•°
